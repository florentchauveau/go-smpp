package pdu

import (
	"bytes"
	"testing"

	"github.com/florentchauveau/go-smpp/smpp/pdu/pdufield"
)

func TestDecodeWithUDH(t *testing.T) {
	tx := []byte{
		0x0, 0x0, 0x0, 0xd6, 0x0, 0x0, 0x0, 0x5,
		0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x2b,
		0x0, 0x1, 0x1, 0x33, 0x33, 0x36, 0x33, 0x39,
		0x39, 0x38, 0x34, 0x32, 0x31, 0x30, 0x0, 0x1,
		0x1, 0x33, 0x33, 0x36, 0x33, 0x39, 0x39, 0x38,
		0x34, 0x32, 0x32, 0x30, 0x0, 0x40, 0x0, 0x0,
		0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x9f, 0x5, 0x0,
		0x3, 0xc1, 0x2, 0x1, 0x45, 0x6e, 0x68, 0x61,
		0x6e, 0x63, 0x65, 0x20, 0x79, 0x6f, 0x75, 0x72,
		0x20, 0x77, 0x6f, 0x72, 0x6b, 0x66, 0x6c, 0x6f,
		0x77, 0x20, 0x77, 0x69, 0x74, 0x68, 0x20, 0x73,
		0x6d, 0x61, 0x72, 0x74, 0x20, 0x61, 0x75, 0x74,
		0x6f, 0x6d, 0x61, 0x74, 0x69, 0x6f, 0x6e, 0x20,
		0x74, 0x68, 0x61, 0x74, 0x20, 0x73, 0x61, 0x76,
		0x65, 0x73, 0x20, 0x74, 0x69, 0x6d, 0x65, 0x2c,
		0x20, 0x72, 0x65, 0x64, 0x75, 0x63, 0x65, 0x73,
		0x20, 0x65, 0x72, 0x72, 0x6f, 0x72, 0x73, 0x2c,
		0x20, 0x65, 0x6d, 0x70, 0x6f, 0x77, 0x65, 0x72,
		0x73, 0x20, 0x79, 0x6f, 0x75, 0x72, 0x20, 0x74,
		0x65, 0x61, 0x6d, 0x2c, 0x20, 0x61, 0x6e, 0x64,
		0x20, 0x61, 0x63, 0x63, 0x65, 0x6c, 0x65, 0x72,
		0x61, 0x74, 0x65, 0x73, 0x20, 0x70, 0x72, 0x6f,
		0x67, 0x72, 0x65, 0x73, 0x73, 0x20, 0x61, 0x63,
		0x72, 0x6f, 0x73, 0x73, 0x20, 0x65, 0x76, 0x65,
		0x72, 0x79, 0x20, 0x70, 0x72, 0x6f, 0x6a, 0x65,
		0x63, 0x74, 0x20, 0x79, 0x6f, 0x75, 0x20, 0x6d,
		0x61, 0x6e, 0x61, 0x67, 0x65,
	}

	pdu, err := Decode(bytes.NewReader(tx))
	if err != nil {
		t.Fatalf("Decode() error: %v", err)
	}
	if pdu.Header().ID != DeliverSMID {
		t.Errorf("Decode() PDU ID = %v, want %v", pdu.Header().ID, DeliverSMID)
	}
	f := pdu.Fields()
	msg, ok := f[pdufield.ShortMessage]
	if !ok {
		t.Fatalf("Decode() missing ShortMessage field")
	}
	wantMsg := "Enhance your workflow with smart automation that saves time, reduces errors, empowers your team, and accelerates progress across every project you manage"
	if msg.String() != wantMsg {
		t.Errorf("Decode() ShortMessage = %q, want %q", msg.String(), wantMsg)
	}
	if f[pdufield.SourceAddr].String() != "33639984210" {
		t.Errorf("Decode() SourceAddr = %q, want %q", f[pdufield.SourceAddr].String(), "33639984210")
	}
	if f[pdufield.DestinationAddr].String() != "33639984220" {
		t.Errorf("Decode() DestinationAddr = %q, want %q", f[pdufield.DestinationAddr].String(), "33639984220")
	}
	udh := pdu.UDH()
	if udh == nil {
		t.Fatalf("Decode() missing UDH field")
	}
	if len(udh.IE) != 1 {
		t.Fatalf("Decode() UDH len(IE) = %d, want %d", len(udh.IE), 1)
	}
	concatenated, ref, total, part := udh.IsConcatenated()
	if !concatenated {
		t.Errorf("Decode() UDH IsConcatenated = %v, want %v", concatenated, true)
	}
	if total != 2 {
		t.Errorf("Decode() UDH IsConcatenated total = %d, want %d", total, 2)
	}
	if ref != 0xc1 {
		t.Errorf("Decode() UDH IsConcatenated ref = %d, want %d", ref, 0xc1)
	}
	if part != 1 {
		t.Errorf("Decode() UDH IsConcatenated part = %d, want %d", part, 1)
	}
}

func TestDecode(t *testing.T) {
	tx := []byte{
		0x0, 0x0, 0x0, 0x3f, 0x0, 0x0, 0x0, 0x5,
		0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x4, 0x92,
		0x0, 0x1, 0x1, 0x33, 0x33, 0x36, 0x33, 0x39,
		0x39, 0x38, 0x37, 0x35, 0x37, 0x35, 0x0, 0x1,
		0x1, 0x33, 0x33, 0x36, 0x33, 0x39, 0x39, 0x38,
		0x31, 0x39, 0x39, 0x39, 0x0, 0x0, 0x0, 0x0,
		0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x8, 0x42,
		0x6f, 0x6e, 0x6a, 0x6f, 0x75, 0x72, 0x73}

	pdu, err := Decode(bytes.NewReader(tx))
	if err != nil {
		t.Fatalf("Decode() error: %v", err)
	}
	if pdu.Header().ID != DeliverSMID {
		t.Errorf("Decode() PDU ID = %v, want %v", pdu.Header().ID, DeliverSMID)
	}
	f := pdu.Fields()
	msg, ok := f[pdufield.ShortMessage]
	if !ok {
		t.Fatalf("Decode() missing ShortMessage field")
	}
	wantMsg := "Bonjours"
	if msg.String() != wantMsg {
		t.Errorf("Decode() ShortMessage = %q, want %q", msg.String(), wantMsg)
	}
	if f[pdufield.SourceAddr].String() != "33639987575" {
		t.Errorf("Decode() SourceAddr = %q, want %q", f[pdufield.SourceAddr].String(), "33639987575")
	}
	if f[pdufield.DestinationAddr].String() != "33639981999" {
		t.Errorf("Decode() DestinationAddr = %q, want %q", f[pdufield.DestinationAddr].String(), "33639981999")
	}
	if pdu.UDH() != nil {
		t.Fatalf("Decode() unexpected UDH field")
	}
}
